<!-- templates/studio/view.html -->
{% extends "nav.html" %}
{% block title %}{{ campaign.title }} • Poster Studio{% endblock %}
{% block content %}

<style>
/* =========================
   Light Theme Tokens (shared)
========================= */
:root{
  --surface:      #f8fafc;
  --card:         #ffffff;
  --card-border:  #e3e8ef;
  --ink:          #1e293b;
  --muted:        #64748b;

  --accent:       #4f46e5;   /* indigo */
  --accent-2:     #818cf8;
  --success-a:    #34d399;   /* for subtle pulses/icons */
}

/* Page bg (if base doesn't) */
body{ background: var(--surface); color: var(--ink); }

/* Utilities */
.text-muted{ color: var(--muted) !important; }

/* Header actions */
.action-row{ gap: .75rem; }
.btn-ghost{
  background: #fff;
  border: 1px solid var(--card-border);
  color: var(--ink);
  border-radius: .8rem;
  padding: .55rem .9rem;
  font-weight: 600;
  text-decoration: none;
  transition: border-color .15s ease, transform .15s ease;
}
.btn-ghost:hover{ transform: translateY(-1px); border-color: var(--accent-2); }

/* Section separators */
.hr-soft{ border: 0; height: 1px; background: var(--card-border); margin: 1rem 0 1.25rem; }

/* Form card */
.form-wrap{
  background: var(--card);
  border: 1px solid var(--card-border);
  border-radius: 1rem;
  padding: 1rem;
  box-shadow: 0 .25rem .75rem rgba(0,0,0,.06);
}
@media (min-width: 768px){ .form-wrap{ padding: 1.25rem; } }

.form-label{ font-weight: 600; color: var(--ink); }
.form-control, .form-select{
  background: #fff; color: var(--ink);
  border: 1px solid var(--card-border);
  border-radius: .6rem;
  padding: .55rem .75rem;
  transition: border-color .15s ease, box-shadow .15s ease;
}
.form-control:focus, .form-select:focus{
  border-color: var(--accent-2);
  box-shadow: 0 0 0 .2rem color-mix(in srgb, var(--accent-2) 25%, transparent);
  outline: none;
}

/* Generate button */
.btn-generate{
  width: 100%;
  background: linear-gradient(135deg, var(--accent), var(--accent-2));
  color: #fff; border: 0; border-radius: .8rem;
  padding: .6rem .9rem; font-weight: 700;
  transition: transform .15s ease, filter .15s ease;
}
.btn-generate:hover{ transform: translateY(-2px); filter: brightness(1.05); }

/* Poster cards */
.card-modern{
  background: var(--card);
  border: 1px solid var(--card-border);
  border-radius: 1rem;
  box-shadow: 0 .25rem .75rem rgba(0,0,0,.06);
  overflow: hidden;
  height: 100%;
  display: flex; flex-direction: column;
}
.card-modern img{
  display: block; width: 100%; height: auto;
  background: #f3f4f6;
}
.card-body{
  padding: .9rem 1rem 1rem;
}
.meta-top{ color: var(--muted); font-size: .86rem; margin-bottom: .35rem; }
.prompt{ font-size: .9rem; color: var(--ink); }

/* Download button */
.btn-download{
  display: inline-flex; align-items: center; gap: .4rem;
  margin-top: .6rem;
  background: #fff; color: var(--ink);
  border: 1px solid var(--card-border);
  border-radius: .7rem;
  padding: .45rem .7rem; font-weight: 600; text-decoration: none;
  transition: border-color .15s ease, transform .15s ease;
}
.btn-download:hover{ transform: translateY(-1px); border-color: var(--accent-2); }

/* Empty state */
.empty{
  background: var(--card);
  border: 1px dashed var(--card-border);
  border-radius: 1rem;
  padding: 2.25rem 1rem;
  text-align: center;
  color: var(--muted);
}
.empty .icon{
  width: 60px; height: 60px; margin: 0 auto 12px;
  display: grid; place-items: center; border-radius: 16px;
  background: var(--accent-2); color: #fff; font-size: 1.6rem;
}

/* Little pulse beside title (optional) */
.pulse{
  width: .5rem; height: .5rem; border-radius: 999px;
  background: var(--success-a);
  box-shadow: 0 0 .6rem .12rem rgba(52,211,153,.45);
  display: inline-block; margin-left: .5rem;
}
  /* Loading overlay */
.loading-overlay{
  position: fixed; inset: 0; z-index: 2000;
  background: rgba(248,250,252,.85); /* var(--surface) with opacity */
  display: none; align-items: center; justify-content: center;
  backdrop-filter: blur(2px);
}
.loading-overlay.show{ display: flex; }

.loading-panel{
  background: #ffffff;
  border: 1px solid var(--card-border);
  border-radius: 1rem;
  box-shadow: 0 .5rem 2rem rgba(0,0,0,.12);
  padding: 1.25rem 1.5rem;
  text-align: center;
  max-width: 420px; width: calc(100% - 2rem);
}

.spinner{
  width: 44px; height: 44px; margin: 4px auto 10px;
  border-radius: 50%;
  border: 3px solid #e5e7eb;
  border-top-color: var(--accent);
  animation: spin 0.8s linear infinite;
}
@keyframes spin{ to { transform: rotate(360deg); } }

.loading-title{
  font-weight: 700; color: var(--ink); margin-bottom: .25rem;
}
.loading-sub{
  color: var(--muted); font-size: .92rem;
}

</style>

<div class="container my-4">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center action-row mb-2">
    <div>
      <h2 class="h4 mb-1">{{ campaign.title }} <span class="pulse"></span></h2>
      <small class="text-muted">{{ campaign.topic }} • {{ campaign.audience|replace('_',' ')|title }}</small>
    </div>
<a class="btn-ghost" target="_blank"
   href="{{ url_for('studio_public', slug=campaign.slug) }}">
  Public page
</a>
  </div>

  <div class="hr-soft"></div>

  <!-- Generate form -->
<div class="form-wrap mb-3">
<form id="genForm" method="post" action="{{ url_for('studio_generate') }}" class="row g-3 align-items-end">
  <input type="hidden" name="campaign_id" value="{{ campaign.id }}">

      <div class="col-md-1">
        <label class="form-label">Week #</label>
        <input class="form-control" type="number" name="week_no" min="1" value="1">
      </div>

      <div class="col-md-5">
        <label class="form-label">Subtheme</label>
        <input class="form-control" name="subtheme" placeholder="common myths, warning signs, teen guidance" required>
      </div>

      <div class="col-md-2">
        <label class="form-label">Width</label>
        <input class="form-control" type="number" name="w" value="1024">
      </div>

      <div class="col-md-2">
        <label class="form-label">Height</label>
        <input class="form-control" type="number" name="h" value="1536">
      </div>

      <div class="col-md-2">
        <button class="btn-generate pe-2" type="submit">Generate</button>
      </div>
    </form>
  </div>

  <!-- Posters grid -->
  <div class="row g-3">
    {% for p in posters %}
      <div class="col-12 col-md-6 col-xl-4">
        <div class="card-modern h-100">
          <img src="/{{ p.img_path }}" alt="poster">
          <div class="card-body">
            <div class="meta-top">Week {{ p.week_no }}</div>
            <div class="prompt">{{ p.prompt }}</div>
            <a class="btn-download" download href="/{{ p.img_path }}">
              <i class="bi bi-download"></i> Download PNG
            </a>
          </div>
        </div>
      </div>
    {% else %}
      <div class="col-12">
        <div class="empty">
          <div class="icon"><i class="bi bi-image"></i></div>
          <div>No posters yet. Use the form above to generate your first one.</div>
        </div>
      </div>
    {% endfor %}
  </div>

</div>
<!-- Loading overlay -->
<div id="genOverlay" class="loading-overlay" aria-hidden="true" role="status">
  <div class="loading-panel" aria-live="polite">
    <div class="spinner"></div>
    <div class="loading-title">Generating your poster…</div>
    <div class="loading-sub">This can take up to a minute. Please don’t close this tab.</div>
  </div>
</div>
<script>
(function(){
  const form = document.getElementById('genForm');
  const overlay = document.getElementById('genOverlay');
  const button = form?.querySelector('.btn-generate');

  if (!form || !overlay) return;

  form.addEventListener('submit', function(){
    // Show overlay immediately (before navigation)
    overlay.classList.add('show');
    overlay.setAttribute('aria-hidden', 'false');
    console.log("called");
    // IMPORTANT: don't disable inputs here; disabled fields are not submitted.
    // If you want to block extra clicks, only disable the button:
    if (button){
      button.disabled = true;
      button.dataset.originalText = button.textContent;
      button.textContent = 'Generating…';
    }
  });
})();
</script>

{% endblock %}
